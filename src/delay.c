/*
****************************************************************************************************
*       INCLUDE FILES
****************************************************************************************************
*/

#include "delay.h"
#include "chip.h"
#include "hardware.h"


/*
****************************************************************************************************
*       INTERNAL MACROS
****************************************************************************************************
*/


/*
****************************************************************************************************
*       INTERNAL CONSTANTS
****************************************************************************************************
*/


/*
****************************************************************************************************
*       INTERNAL DATA TYPES
****************************************************************************************************
*/


/*
****************************************************************************************************
*       INTERNAL GLOBAL VARIABLES
****************************************************************************************************
*/

static uint32_t g_factor;


/*
****************************************************************************************************
*       INTERNAL FUNCTIONS
****************************************************************************************************
*/


/*
****************************************************************************************************
*       GLOBAL FUNCTIONS
****************************************************************************************************
*/

void delay_init(void)
{
    g_factor = Chip_Clock_GetSystemClockRate() / 4000000;
}

inline void delay_us(uint32_t us)
{
    /*
     * Based on Paul Stoffregen's implementation
     * for Teensy 3.0 (http://www.pjrc.com/)
     */
    if (us == 0) return;
    uint32_t n = us * g_factor;
    asm(".syntax unified");
    asm volatile(
        "L_%=_delay_us:"       "\n\t"
        "subs   %0, #1"        "\n\t"
        "bne    L_%=_delay_us" "\n"
        : "+r" (n) :
    );
    asm(".syntax divided");
}

void delay_ms(uint32_t ms)
{
    uint32_t start = hw_uptime();
    while ((hw_uptime() - start) < ms);
}
