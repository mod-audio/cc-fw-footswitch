/*
************************************************************************************************************************
*       INCLUDE FILES
************************************************************************************************************************
*/

#include "msg.h"
#include "device.h"


/*
************************************************************************************************************************
*       INTERNAL MACROS
************************************************************************************************************************
*/


/*
************************************************************************************************************************
*       INTERNAL CONSTANTS
************************************************************************************************************************
*/


/*
************************************************************************************************************************
*       INTERNAL DATA TYPES
************************************************************************************************************************
*/


/*
************************************************************************************************************************
*       INTERNAL GLOBAL VARIABLES
************************************************************************************************************************
*/


/*
************************************************************************************************************************
*       INTERNAL FUNCTIONS
************************************************************************************************************************
*/


/*
************************************************************************************************************************
*       GLOBAL FUNCTIONS
************************************************************************************************************************
*/

int cc_msg_parser(const cc_msg_t *msg, void *data_struct)
{
    if (msg->command == CC_CMD_HANDSHAKE)
    {
        uint8_t *pdata = data_struct;
        *pdata++ = msg->data[1];
        *pdata++ = msg->data[0];
    }

    return 0;
}

int cc_msg_builder(int command, const void *data_struct, cc_msg_t *msg)
{
    msg->command = command;

    if (command == CC_CMD_HANDSHAKE)
    {
        const uint8_t *pdata = data_struct;
        msg->data_size = 2;
        msg->data[1] = *pdata++;
        msg->data[0] = *pdata++;
    }
    else if (command == CC_CMD_DEV_DESCRIPTOR)
    {
        const cc_dev_descriptor_t *desc = data_struct;
        uint8_t *pdata = msg->data;

        // serialize label
        pdata += string_serialize(desc->label, pdata);

        // serialize actuators data
        *pdata++ = desc->actuators_count;
        for (int i = 0; i < desc->actuators_count; i++)
        {
            *pdata++ = desc->actuators[i]->id;
        }

        msg->data_size = (pdata - msg->data);
    }
    else if (command == CC_CMD_DATA_UPDATE)
    {
    }
    else
    {
        return -1;
    }

    return 0;
}
